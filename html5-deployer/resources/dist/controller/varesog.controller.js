sap.ui.define(["./BaseController","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","./Formatter"],function(e,r,t,o,a,n,i,s){"use strict";return e.extend("rm.webshop.shop.controller.varesog",{_oOrderDialog:null,_oFinalConfirmationDialog:null,_oOrderSentDialog:null,formatter:s,onInit:function(){var e=sap.ui.require.toUrl("rm/webshop/shop")+"/img/Logo.jpg";var r=new t({rmLogo:e,basket:[],selectedAddressOption:0,UserInfo:{navn:"",adresse:"",zip:"",by:"",tlfnr:"",brugernr:"",afdeling:""}});this.getView().setModel(r,"view");var o=new t({orders:[]});this.getOwnerComponent().setModel(o,"webshop");this._fetchUserData();this.getOwnerComponent().getRouter().getRoute("Routevaresog").attachPatternMatched(this._onRouteMatched,this)},_getCurrentUserNo:function(){const e=this.getOwnerComponent().getModel("globalUser");return e?e.getProperty("/UserNo"):null},_onRouteMatched:function(e){const r=this._getCurrentUserNo();var t=this.byId("idTopLevelTab");if(t){t.setSelectedKey("HeadSoegning")}this._loadCatalogSet(r);this._loadBasket(r);this._fetchUserData()},_loadBasket:function(e){var r=this.getOwnerComponent().getModel();var t=this.getView().getModel("view");var o=[new(n||sap.ui.model.Filter)("UserNo",(i||sap.ui.model.FilterOperator).EQ,e)];r.read("/BasketSet",{filters:o,success:function(e){t.setProperty("/shoppingcart",e.results);console.log("BasketSet loaded:",e.results)},error:function(e){sap.m.MessageBox.error("Failed to load shopping cart data.");console.error("BasketSet read error",e)}})},_loadCatalogSet:function(e){var r=this.getOwnerComponent().getModel();var t=this.getView().getModel("view");const o=sap.ui.model.Filter;const a=sap.ui.model.FilterOperator;var n=[new o("UserNo",a.EQ,e)];sap.ui.core.BusyIndicator.show(0);r.read("/CatalogSet",{filters:n,urlParameters:{$expand:"CatalogAttributeSet",$format:"json"},success:function(e,r){sap.ui.core.BusyIndicator.hide();t.setProperty("/catalog",e.results);console.log("CatalogSet with Attributes loaded:",e.results)}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("Failed to load catalog data.");console.error("CatalogSet read error",e)}.bind(this)})},handleIconTabBarSelect:function(e){var r=e.getParameter("selectedKey");if(r==="HeadSoegning"){this.getOwnerComponent().getRouter().navTo("Routevaresog")}if(r==="HeadOversigt"){this.getOwnerComponent().getRouter().navTo("Routebestilling")}if(r==="HeadProfil"){this.getOwnerComponent().getRouter().navTo("Routeprofil")}if(r==="HeadSupport"){this.getOwnerComponent().getRouter().navTo("Routesupport")}},onSearchMaterials:function(e){var r=e.getParameter("newValue");var t=[];if(r){var o=new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.Contains,r);var a=new sap.ui.model.Filter("Maktx",sap.ui.model.FilterOperator.Contains,r);var n=new sap.ui.model.Filter("MaktxLong",sap.ui.model.FilterOperator.Contains,r);var i=new sap.ui.model.Filter("Levmat",sap.ui.model.FilterOperator.Contains,r);var s=new sap.ui.model.Filter("KeywordSearch",sap.ui.model.FilterOperator.Contains,r);var l=new sap.ui.model.Filter({filters:[o,a,n,i,s],and:false});t.push(l)}var d=this.getView().byId("catalogList");var g=d.getBinding("items");g.filter(t)},onAddToCart:function(e){var t=e.getSource();var o=t.getBindingContext("view");var n=o.getObject();const i=this._getCurrentUserNo();var s=n.GuidMat;var l=n.Matnr;var d={UserNo:i,GuidMat:n.GuidMat,OrderQuantity:n.Multiplum};var g=this.getOwnerComponent().getModel();var u="/BasketSet";g.create(u,d,{success:function(e){this._loadBasket(i);r.show(e.Maktx+" tilføjet til kurv")}.bind(this),error:function(e){var r="Fejl ved tilføjelse til kurv. Prøv igen";try{if(e&&e.responseText){var t=JSON.parse(e.responseText);if(t.error&&t.error.message&&t.error.message.value){r=t.error.message.value}else if(t.error&&t.error.innererror&&t.error.innererror.errordetails&&t.error.innererror.errordetails.length>0){r=t.error.innererror.errordetails[0].message||r}}else if(e&&e.message){r=e.message}}catch(e){console.error("Fejl ved parsing af OData fejl:",e)}a.error(r);console.error("Varekurv fejl:",e)}})},onDecreaseQuantity:function(e){var t=e.getSource();var o=t.getBindingContext("view");var n=o.getObject();const i=this._getCurrentUserNo();var s=n.GuidMat;var l=n.Matnr;var d=n.Multiplum;var g="-"+d.toString();var u={UserNo:i,GuidMat:n.GuidMat,OrderQuantity:g};var c=this.getOwnerComponent().getModel();var h="/BasketSet";c.create(h,u,{success:function(e){this._loadBasket(i);r.show(n.Maktx+" fjernet fra kurv")}.bind(this),error:function(e){a.error("Fejl ved opdatering af varekurv. Prøv igen.");console.error("Varekurv fejl:",e)}})},onRemoveFromCart:function(e){var t=e.getSource();var o=t.getBindingContext("view");var n=o.getObject();const i=this._getCurrentUserNo();var s=n.Matnr;var l=parseInt(n.OrderQuantity,10);var d="-"+l.toString();if(l<=0||isNaN(l)){r.show("Kurven er tom");return}var g={UserNo:i,GuidMat:n.GuidMat,OrderQuantity:d};var u=this.getOwnerComponent().getModel();var c="/BasketSet";u.create(c,g,{success:function(e){this._loadBasket(i);r.show(n.Maktx+" fjernet fra kurv")}.bind(this),error:function(e){a.error("Failed to remove material from cart. Please try again.");console.error("BasketSet create error:",e)}})},onOrder:function(){var e=this.getView().getModel("view").getProperty("/shoppingcart")||[];var t=e.reduce(function(e,r){return e+parseInt(r.OrderQuantity,10)},0);if(t===0){r.show("Kurven er tom.");return}if(!this._oOrderDialog){o.load({id:this.getView().getId(),name:"rm.webshop.shop.view.fragment.OrderDialog",controller:this}).then(function(e){this._oOrderDialog=e;this.getView().addDependent(e);this._setupOrderDialog(t)}.bind(this))}else{this._setupOrderDialog(t)}},_setupOrderDialog:function(e){var r=this.getView().getModel("view");var o=r.getProperty("/UserContact")||{email:"",phone:"",address:{}};var a=new t({alternativeAddress:{streetName:"",streetNr:"",postalCode:"",city:""},contactInfo:{email:o.email,phone:o.phone},registeredAddress:o.address,totalItems:e,selectedAddressOption:0,chosenAddress:null});this._oOrderDialog.setModel(a,"orderDialog");this._oOrderDialog.open()},onConfirmOrder:function(){var e=this._oOrderDialog.getModel("orderDialog");var r=e.getData();var t;var o=r.selectedAddressOption;var n=this.getOwnerComponent().getModel("webshop");if(o===0){var i=this.getView().getModel("view");var s=i.getProperty("/UserContact/address");if(!s||!s.streetName){a.error("Der mangler registreret adresseinformation for brugeren.");return}t=s.streetName+" "+s.streetNr+", "+s.postalCode+" "+s.city}else{var l=r.alternativeAddress;if(!l.streetName||!l.streetNr||!l.postalCode||!l.city){a.error("Udfyld venligst alle felter for den alternative adresse.");return}t=l.streetName+" "+l.streetNr+", "+l.postalCode+" "+l.city}var d=this.byId("phoneInput");var g=d.getValue()||"";var u=g.replace(/[^0-9]/g,"");if(u.length===0){a.error("Telefonnummer er obligatorisk.");return}else if(u.length!==8){a.error("Telefonnummeret skal bestå af præcis 8 cifre (uden landekode).");return}var c="+45 "+u;r.contactInfo.phone=c;r.chosenAddress=t;e.setData(r);this._openFinalConfirmationDialog()},onCancelOrder:function(){this._oOrderDialog.close()},_openFinalConfirmationDialog:function(){if(!this._oFinalConfirmationDialog){o.load({id:this.getView().getId(),name:"rm.webshop.shop.view.fragment.FinalConfirmationDialog",controller:this}).then(function(e){this._oFinalConfirmationDialog=e;this.getView().addDependent(e);this._setupFinalConfirmationDialog()}.bind(this))}else{this._setupFinalConfirmationDialog()}},_setupFinalConfirmationDialog:function(){var e=this._oOrderDialog.getModel("orderDialog").getData();this.byId("finalAddressText").setText(e.chosenAddress);this.byId("finalEmailText").setText("Email: "+e.contactInfo.email);this.byId("finalPhoneText").setText("Telefon: "+e.contactInfo.phone);this.byId("finalConfirmationText").setText(this.getResourceBundle().getText("Bekræft venligst din bestilling.")||"Bekræft venligst din bestilling.");this._oFinalConfirmationDialog.open()},onFinalOrder:function(){this._oFinalConfirmationDialog.close();this._openOrderSentDialog()},onFinalCancel:function(){this._oFinalConfirmationDialog.close()},_openOrderSentDialog:function(){if(!this._oOrderSentDialog){o.load({id:this.getView().getId(),name:"rm.webshop.shop.view.fragment.OrderSentDialog",controller:this}).then(function(e){this._oOrderSentDialog=e;this.getView().addDependent(e);this._setupOrderSentDialog()}.bind(this))}else{this._setupOrderSentDialog()}},_setupOrderSentDialog:function(){var e=this._oOrderDialog.getModel("orderDialog");var r=e.getProperty("/contactInfo/email");var t;if(!r||r.trim()===""){var o=e.getProperty("/contactInfo/phone");t="Ordren er bestilt. Du vil modtage en besked på "+o+" ved levering."}else{t=this.getResourceBundle().getText("orderSentConfirmation",[r])}var a=this.byId("orderSentText");if(a){a.setText(t)}this._oOrderSentDialog.open()},onOrderSentConfirm:function(){this._oOrderSentDialog.close();this._processFinalOrder()},_processFinalOrder:function(){var e=this;var r=this._oOrderDialog.getModel("orderDialog");var t=r.getData();var o=this.getOwnerComponent().getModel();var n=this.getView().getModel("view");const i=this._getCurrentUserNo();var s=t.chosenAddress||"";var l=s.split(",");var d=l[0]?l[0].trim():"";var g=l[1]?l[1].trim():"";var u=d;var c=g.split(" ");var h=c[0]||"";var p=c.slice(1).join(" ")||"";var v=n.getProperty("/UserContact")||{};var f={UserNo:i,Name:n.getProperty("/UserInfo/navn")||"",Name2:"",Street:u||v.address.streetName+" "+v.address.streetNr,Zip:h||v.address.postalCode,City:p||v.address.city,Att:"",Phone:t.contactInfo.phone||v.phone,EMail:t.contactInfo.email||v.email};o.create("/OrderHeaderSet",f,{success:function(r,t){var o=r.OrderNumber||"Ukendt";a.success("Ordren "+o+" er afsendt.");e._oOrderDialog.close();e._loadBasket(i);e.getOwnerComponent().getRouter().navTo("Routebestilling")},error:function(e){a.error("Fejl ved afsendelse af ordre. Prøv igen.");console.error("OrderHeaderSet CREATE error:",e)}})},_fetchUserData:function(){var e=this.getOwnerComponent().getModel();var t=this.getView().getModel("view");const o=this._getCurrentUserNo();const a=`/UserSet('${o}')`;if(!e){r.show("Error: OData model not available.");return}e.read(a,{urlParameters:{$format:"json"},success:function(e){t.setProperty("/UserInfo",{navn:e.AdrName||"N/A",adresse:e.AdrStreet||"N/A",zip:e.AdrZip||"N/A",by:e.AdrCity||"N/A",tlfnr:e.Phone||"Ukendt, kan opdateres i 'Profil'",brugernr:e.UserNo||"N/A",afdeling:e.Afdeling});t.setProperty("/UserContact",{email:e.EMail||"",phone:e.Phone||"",address:{streetName:e.AdrStreet||"",streetNr:e.AdrHouseNo||"",postalCode:e.AdrZip||"",city:e.AdrCity||""}})}.bind(this),error:function(e){r.show("Failed to load user data.");console.error("OData Read failed:",e);t.setProperty("/UserInfo",{navn:"Fejl: Kunne ikke hente data",adresse:"",zip:"",by:"",tlfnr:"",brugernr:"",afdeling:""})}.bind(this)})},onBack(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("Routemain")}})});
//# sourceMappingURL=varesog.controller.js.map