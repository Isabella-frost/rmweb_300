sap.ui.define(["./BaseController","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","./Formatter"],function(e,r,t,o,a,n,s){"use strict";return e.extend("rm.webshop.test.controller.bestilling",{formatter:s,onInit:function(){var e=sap.ui.require.toUrl("rm/webshop/test")+"/img/Logo.jpg";var r=new t({rmLogo:e,UserInfo:{navn:"",adresse:"",zip:"",by:"",tlfnr:"",brugernr:"",afdeling:""}});this.getView().setModel(r,"view");this._fetchUserData();this.getOwnerComponent().getRouter().getRoute("Routebestilling").attachPatternMatched(this._onRouteMatched,this)},_getCurrentUserNo:function(){const e=this.getOwnerComponent().getModel("globalUser");return e?e.getProperty("/UserNo"):null},_onRouteMatched:function(e){const r=this._getCurrentUserNo();var t=this.byId("idTopLevelTab");if(t){t.setSelectedKey("HeadOversigt")}this._loadOrderHeaders(r);this._fetchUserData()},_loadOrderHeaders:function(e){var r=this.getOwnerComponent().getModel();var t=this.byId("orderList");var o=this;var a=[new sap.ui.model.Filter("UserNo",sap.ui.model.FilterOperator.EQ,e)];r.read("/OrderHeaderSet",{filters:a,urlParameters:{$expand:"OrderItemSet,OrderItemSet/TrackTraceSet"},success:function(e){var r=e.results.map(function(e){e.items=e.OrderItemSet.results.map(function(e){var r="";if(e.TrackTraceSet&&e.TrackTraceSet.results&&e.TrackTraceSet.results.length>0){e.TrackTraces=e.TrackTraceSet.results.map(function(e){let r="";if(e.OrderQuantity!==undefined&&e.OrderQuantity!==null&&e.OrderQuantity!==""){r=e.OrderQuantity.toString().replace(".",",")}return{UrlTrackTrace:e.UrlTrackTrace,TtStatusText:e.TtStatusText||"",OrderQuantity:r,CreateDateEdit:e.CreateDateEdit||""}})}else{e.TrackTraces=[]}delete e.TrackTraceSet;return e});delete e.OrderItemSet;return e});var a=new sap.ui.model.json.JSONModel({orders:r});o.getView().setModel(a,"ordersModel");t.bindItems({path:"ordersModel>/orders",template:t.getItems()[0].clone()});t.attachEventOnce("updateFinished",function(){var e=t.getItems();if(e.length>0){t.setSelectedItem(e[0],true);o.onOrderSelect(e[0])}});var n=o.byId("showClosedOrdersCheckbox");o.onShowClosedOrdersToggle({getParameter:()=>n.getSelected()});console.log("OrderHeaderSet (with TrackTraceSet) loaded:",r.length,"orders")},error:function(e){sap.m.MessageBox.error("Fejl ved load af bestillingshistorik. Genindlæs siden.");console.error("OrderHeaderSet read error:",e)}})},onShowClosedOrdersToggle:function(e){var r=e.getParameter("selected");var t=this.byId("orderList");var o=t.getBinding("items");if(!o)return;if(r){o.filter([])}else{var a=new sap.ui.model.Filter({path:"HeaderStatus",operator:sap.ui.model.FilterOperator.NE,value1:"SHIP"});o.filter([a])}},onOrderSelect:function(e){var r=e.getParameter?e.getParameter("listItem"):e;var t=r.getBindingContext("ordersModel");if(!t)return;var o=t.getPath();var a=this.byId("orderItemsList");if(a){a.bindItems({path:o+"/items",model:"ordersModel",template:a.getItems()[0].clone()})}},handleIconTabBarSelect:function(e){var r=e.getParameter("selectedKey");if(r==="HeadSoegning"){this.getOwnerComponent().getRouter().navTo("Routevaresog")}if(r==="HeadOversigt"){this.getOwnerComponent().getRouter().navTo("Routebestilling")}if(r==="HeadProfil"){this.getOwnerComponent().getRouter().navTo("Routeprofil")}if(r==="HeadSupport"){this.getOwnerComponent().getRouter().navTo("Routesupport")}},_fetchUserData:function(){var e=this.getOwnerComponent().getModel();var t=this.getView().getModel("view");const o=this._getCurrentUserNo();const a=`/UserSet('${o}')`;if(!e){r.show("Error: OData model not available.");return}e.read(a,{urlParameters:{$format:"json"},success:function(e){t.setProperty("/UserInfo",{navn:e.AdrName||"N/A",adresse:e.AdrStreet||"N/A",zip:e.AdrZip||"N/A",by:e.AdrCity||"N/A",tlfnr:e.Phone||"Ukendt, kan opdateres i 'Profil'",brugernr:e.UserNo||"N/A",afdeling:e.Afdeling})}.bind(this),error:function(e){r.show("Failed to load user data.");console.error("OData Read failed:",e);t.setProperty("/UserInfo",{navn:"Fejl: Kunne ikke hente data",adresse:"",zip:"",by:"",tlfnr:"",brugernr:"",afdeling:""})}.bind(this)})},onCopyOrderItem:function(e){var t=e.getSource();var a=t.getBindingContext("ordersModel");if(!a){r.show("Fejl: Kunne ikke finde vareoplysninger.");return}var n=a.getObject();const s=this._getCurrentUserNo();var i=n.GuidMat;var l=n.Matnr;var d=String(n.OrderQuantity);var u={UserNo:s,GuidMat:i,OrderQuantity:d};var g=this.getOwnerComponent().getModel();var c="/BasketSet";g.create(c,u,{success:function(e){if(this._loadBasket){this._loadBasket(s)}r.show(n.Maktx+" ("+d+" stk) tilføjet til kurv")}.bind(this),error:function(e){var r="Fejl: Kunne ikke tilføje vare til kurven. Prøv venligst igen.";try{if(e&&e.responseText){var t=JSON.parse(e.responseText);if(t.error&&t.error.innererror&&t.error.innererror.errordetails&&t.error.innererror.errordetails.length>0){r=t.error.innererror.errordetails[0].message||r}else if(t.error&&t.error.message&&t.error.message.value){r=t.error.message.value}}else if(e&&e.message){r=e.message}}catch(e){console.error("Fejl ved parsing af OData fejl:",e)}o.error(r);console.error("BasketSet create error for item "+l+":",e)}.bind(this)})},onCopyOrder:async function(){var e=this.byId("orderItemsList");var r=e.getItems();var t=this;var o=[];var a=0;const n=this._getCurrentUserNo();if(r.length===0){sap.m.MessageToast.show("Ingen varer at kopiere.");return}sap.ui.core.BusyIndicator.show(0);for(const e of r){var s=e.getBindingContext("ordersModel");var i=s.getObject();var l={UserNo:n,GuidMat:i.GuidMat,OrderQuantity:String(i.OrderQuantity)};try{await this._createBasketItem(l,i.Maktx);a++}catch(e){o.push(e)}}sap.ui.core.BusyIndicator.hide();if(t._loadBasket){t._loadBasket(n)}if(o.length>0){var d=o.join(", \n");var u=`Følgende ${o.length} varer kunne IKKE tilføjes til kurven, da de ikke længere er tilgængelige:\n\n${d}`;sap.m.MessageBox.warning(u,{title:"Nogle varer er utilgængelige"})}if(a>0){sap.m.MessageToast.show(`${a} vare(r) fra ordren er tilføjet til kurven.`)}else if(o.length>0){sap.m.MessageToast.show("Ingen varer blev tilføjet til kurven.")}},_createBasketItem:function(e,r){var t=this.getOwnerComponent().getModel();var o="/BasketSet";return new Promise((a,n)=>{t.create(o,e,{success:function(e){a()},error:function(e){console.error(`Error adding item ${r} to basket:`,e);n(r)}})})},onBack:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);var r=this.getView().getModel("view");var t=this._getCurrentUserNo();var o=this.getOwnerComponent().getModel();var a=[new sap.ui.model.Filter("UserNo",sap.ui.model.FilterOperator.EQ,t)];o.read("/BasketSet",{filters:a,success:function(r){var t=r.results||[];if(t.length>0){sap.m.MessageBox.confirm("Du har varer i din kurv. Vil du fortsat logge af? (Din kurv gemmes til næste besøg)",{title:"Bekræft log af",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(r){if(r===sap.m.MessageBox.Action.OK){e.navTo("Routemain")}}})}else{e.navTo("Routemain")}},error:function(r){sap.m.MessageBox.warning("Kunne ikke hente din kurv. Vil du fortsætte med at logge af?",{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(r){if(r===sap.m.MessageBox.Action.OK){e.navTo("Routemain")}}});console.error("BasketSet read error during logoff:",r)}})},onOpenBasket:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("Routevaresog")}})});
//# sourceMappingURL=bestilling.controller.js.map