sap.ui.define(["./BaseController","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,o,r,s,i){"use strict";return e.extend("rm.webshop.test.controller.xdocprofil",{_oInitialUserData:{},onInit:function(){var e=sap.ui.require.toUrl("rm/webshop/test")+"/img/Logo.jpg";var t=new o({rmLogo:e,selectedTabKey:"HeadXProfil",UserInfo:{doctor:"",ydernr:"",cvrnr:"",brugernr:"",street:"",zip:"",city:"",phone:"",mail:"",favorite:""}});this.getView().setModel(t,"view");this.getView().setModel(new o({lists:[]}),"webshop");this._fetchUserData();this._fetchFavoriteLists();this.getOwnerComponent().getRouter().getRoute("Routexdocprofil").attachPatternMatched(this._onRouteMatched,this)},_getCurrentUserNo:function(){const e=this.getOwnerComponent().getModel("globalUser");return e?e.getProperty("/UserNo"):null},_fetchUserData:function(){const e=this._getCurrentUserNo();var o=this.getOwnerComponent().getModel();var r=this.getView().getModel("view");const s=`/UserSet('${e}')`;if(!o){t.show("Error: OData model not available.");return}o.read(s,{urlParameters:{$format:"json"},success:function(e){this._oInitialUserData=e;r.setProperty("/UserInfo",{doctor:e.AdrName||"N/A",ydernr:e.Ydernr||"N/A",cvrnr:e.Cvr||"N/A",brugernr:e.UserNo||"N/A",street:e.AdrStreet||"N/A",zip:e.AdrZip||"N/A",city:e.AdrCity||"N/A",phone:e.Phone||"Udfyld her",mail:e.EMail||"Udfyld her",favorite:e.FavoriteList})}.bind(this),error:function(e){t.show("Failed to load user data.");console.error("OData Read failed:",e)}.bind(this)})},_fetchFavoriteLists:function(){var e=this.getOwnerComponent().getModel();var o=this.getView().getModel("webshop");const r=this._getCurrentUserNo();const n={UserNo:r||"",FavoriteList:"Alle varer",GuidMat:"0"};if(!e){o.setProperty("/lists",[n]);return}const a=[new s("UserNo",i.EQ,r)];e.read("/FavoriteSet",{filters:a,urlParameters:{$format:"json"},success:function(e){let t=e.results||[];t.unshift(n);o.setProperty("/lists",t);console.log("Favorite lists loaded:",t)}.bind(this),error:function(e){t.show("Kunne ikke hente favoritlister. Viser kun 'Alle varer'.");o.setProperty("/lists",[n]);console.error("FavoriteSet read error:",e)}})},_onRouteMatched:function(e){var t=this.byId("idTopLevelTab");if(t){t.setSelectedKey("HeadXProfil")}},handleIconTabBarSelect:function(e){var t=e.getParameter("selectedKey");var o=this.getOwnerComponent().getRouter();this.getView().getModel("view").setProperty("/selectedTabKey",t);if(t==="HeadXProfil"){return}if(t==="HeadXSoegning"){o.navTo("Routexdocvaresog")}else if(t==="HeadInfo"){o.navTo("Routeinfo")}else if(t==="HeadXOversigt"){o.navTo("Routexdocbestilling")}else if(t==="HeadXSupport"){o.navTo("Routexdocsupport")}},onUpdateContactInfo:function(){var e=this.getView().getModel("view");var t=e.getProperty("/UserInfo");var o={Phone:t.phone,EMail:t.mail};this._updateUser(o,"Kontaktoplysninger")},onUpdateFavoriteList:function(){var e=this.getView().getModel("view");var t=e.getProperty("/UserInfo/favorite");if(t==="Alle varer"||!t){t=""}var o={FavoriteList:t};this._updateUser(o,"Favoritliste")},_updateUser:function(e,o){var r=this.getOwnerComponent().getModel();var s=this._oInitialUserData;const i=this._getCurrentUserNo();if(!r){t.show("Fejl: OData model ikke tilgængelig.");return}var n={UserNo:i,DelName:s.DelName,Phone:s.Phone,EMail:s.EMail,FavoriteList:s.FavoriteList,...e};r.create("/UserSet",n,{success:function(r,s){t.show(o+" opdateret succesfuldt!");if(e.Phone){this.getView().getModel("view").setProperty("/UserInfo/phone",e.Phone)}}.bind(this),error:function(e){t.show("Fejl ved opdatering af "+o.toLowerCase()+".");console.error("OData Create (Update) failed:",e)}})},onBack:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);var t=this.getView().getModel("view");var o=this._getCurrentUserNo();var r=this.getOwnerComponent().getModel();var s=[new sap.ui.model.Filter("UserNo",sap.ui.model.FilterOperator.EQ,o)];r.read("/BasketSet",{filters:s,success:function(t){var o=t.results||[];if(o.length>0){sap.m.MessageBox.confirm("Du har varer i din kurv. Vil du fortsat logge af? (Din kurv gemmes til næste besøg)",{title:"Bekræft log af",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(t){if(t===sap.m.MessageBox.Action.OK){e.navTo("Routemain")}}})}else{e.navTo("Routemain")}},error:function(t){sap.m.MessageBox.warning("Kunne ikke hente din kurv. Vil du fortsætte med at logge af?",{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(t){if(t===sap.m.MessageBox.Action.OK){e.navTo("Routemain")}}});console.error("BasketSet read error during logoff:",t)}})},onOpenBasket:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("Routexdocvaresog")}})});
//# sourceMappingURL=xdocprofil.controller.js.map