sap.ui.define(["./BaseController","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","./Formatter"],function(e,t,r,o,i,s,n,a){"use strict";return e.extend("rm.webshop.test.controller.xdocvaresog",{_oOrderDialog:null,_oFinalConfirmationDialog:null,_oOrderSentDialog:null,formatter:a,onInit:function(){var e=sap.ui.require.toUrl("rm/webshop/test")+"/img/Logo.jpg";var t=new r({rmLogo:e,basket:[],selectedAddressOption:0,selectedTabKey:"HeadXSoegning",selectedList:"Alle varer",UserInfo:{doctor:"",ydernr:"",cvrnr:"",brugernr:""}});this.getView().setModel(t,"view");var o=new r({orders:[],lists:[]});this.getView().setModel(o,"webshop");this._fetchInitFav();this._fetchUserData();this._fetchFavoriteLists();this.getOwnerComponent().getRouter().getRoute("Routexdocvaresog").attachPatternMatched(this._onRouteMatched,this)},_getCurrentUserNo:function(){const e=this.getOwnerComponent().getModel("globalUser");return e?e.getProperty("/UserNo"):null},_fetchFavoriteLists:function(){var e=this.getOwnerComponent().getModel();var r=this.getView().getModel("webshop");const o=this._getCurrentUserNo();const i={UserNo:o||"",FavoriteList:"Alle varer",GuidMat:"0"};if(!e){r.setProperty("/lists",[i]);return}const a=[new s("UserNo",n.EQ,o)];e.read("/FavoriteSet",{filters:a,urlParameters:{$format:"json"},success:function(e){let t=e.results||[];t.unshift(i);r.setProperty("/lists",t)}.bind(this),error:function(e){t.show("Fejl i load af favoritliste.");r.setProperty("/lists",[i]);console.error("OData læs favoritliste fejl:",e)}})},_onRouteMatched:function(e){var t=this.byId("idTopLevelTab");if(t){t.setSelectedKey("HeadXSoegning")}var r=this.getView().getModel("view");var o=this;const i=this._getCurrentUserNo();var s=function(){var e=r.getProperty("/selectedList");if(e){o._loadBasket(i)}else{setTimeout(s,100)}};s();this._fetchInitFav();this._fetchUserData();this._fetchFavoriteLists()},_getFavoriteListDialog:function(){if(!this._oFavoriteListDialog){this._oFavoriteListDialog=o.load({id:this.getView().getId(),name:"rm.webshop.test.view.fragment.FavoriteListDialog",controller:this}).then(function(e){this.getView().addDependent(e);return e}.bind(this))}return this._oFavoriteListDialog},onAddToFavoriteList:function(e){const t=e.getSource().getBindingContext("view");const r=t.getObject();this.getView().getModel("webshop").setProperty("/materialToAdd",r);this.getView().getModel("webshop").setProperty("/newListName","");this._getFavoriteListDialog().then(function(e){this.byId("listSelectContainer").setVisible(true);this.byId("newListInputContainer").setVisible(false);this.byId("saveListButton").setText(this.getResourceBundle().getText("selectListSave"));e.open()}.bind(this))},onCreateNewList:function(){this.byId("listSelectContainer").setVisible(false);this.byId("newListInputContainer").setVisible(true);this.byId("saveListButton").setText(this.getResourceBundle().getText("createListSave"))},onSaveFavoriteList:function(e){const r=this.getView().getModel("webshop");const o=this.getView().getModel("view");const s=r.getProperty("/materialToAdd");const n=this.getOwnerComponent().getModel();const a=this._getCurrentUserNo();let l;if(this.byId("newListInputContainer").getVisible()){l=r.getProperty("/newListName").trim();if(!l){t.show(this.getResourceBundle().getText("listNameRequired"));return}}else{const e=this.byId("favoriteListDialogSelect").getSelectedItem();if(!e){t.show(this.getResourceBundle().getText("listSelectionRequired"));return}l=e.getText()}const d={UserNo:a,FavoriteList:l,GuidMat:s.GuidMat};n.create("/FavoriteSet",d,{success:function(e){t.show(this.getResourceBundle().getText("favoriteAddSuccess",[l]));this.byId("favoriteListDialog").close();const r=o.getProperty("/selectedList");if(this.byId("newListInputContainer").getVisible()){this._fetchFavoriteLists()}if(l===r||r==="Alle varer"){this._loadCatalogSet(a,r)}}.bind(this),error:function(e){i.error(this.getResourceBundle().getText("Fejl ved tilføjelse af favoritliste",[l]));console.error("Oprettelse af favoritliste er fejlet:",e)}.bind(this)})},onCloseFavoriteListDialog:function(){this.byId("favoriteListDialog").close()},_getRemoveFromListDialog:function(){if(!this._oRemoveFromListDialog){this._oRemoveFromListDialog=sap.ui.core.Fragment.load({id:this.getView().getId(),name:"rm.webshop.test.view.fragment.RemoveFromFavoriteListDialog",controller:this}).then(function(e){this.getView().addDependent(e);return e}.bind(this))}return this._oRemoveFromListDialog},onRemoveFromFavoriteList:function(e){const t=e.getSource().getBindingContext("view");const r=t.getObject();this.getView().getModel("webshop").setProperty("/materialToRemove",r);const o=r.IncludedInFavorites||"";const i=o.split(",").map(e=>e.trim()).filter(e=>e&&e!=="Alle varer");const s=this.getView().getModel("webshop").getProperty("/lists").filter(e=>e.FavoriteList!=="Alle varer");const n=s.filter(e=>i.includes(e.FavoriteList));this.getView().getModel("webshop").setProperty("/removableLists",n);this._getRemoveFromListDialog().then(function(e){this.byId("favoriteListDialogSelectRemove").setSelectedKey(null);e.open()}.bind(this))},onConfirmRemoveFavorite:function(){const e=this.getView().getModel("webshop");const t=this.getView().getModel("view");const r=this.getOwnerComponent().getModel();const o=this._getCurrentUserNo();const i=e.getProperty("/materialToRemove");const s=this.byId("favoriteListDialogSelectRemove");const n=s.getSelectedKey();if(!n){sap.m.MessageToast.show(this.getResourceBundle().getText("listSelectionRequired"));return}const a=r.createKey("/FavoriteSet",{UserNo:o,FavoriteList:n,GuidMat:i.GuidMat});r.remove(a,{success:function(e){sap.m.MessageToast.show(this.getResourceBundle().getText("Varen blev fjernet"));this.byId("favoriteListDialogRemove").close();const r=t.getProperty("/selectedList");if(n===r||r==="Alle varer"){this._loadCatalogSet(o,r)}}.bind(this),error:function(e){sap.m.MessageBox.error(this.getResourceBundle().getText("Varen blev ikke fjernet fra favoritlisten. Prøv igen."));console.error("FavoriteSet Delete er fejlet:",e)}.bind(this)})},onCloseRemoveFromListDialog:function(){this.byId("favoriteListDialogRemove").close()},_loadBasket:function(e){var t=this.getOwnerComponent().getModel();var r=this.getView().getModel("view");var o=[new(s||sap.ui.model.Filter)("UserNo",(n||sap.ui.model.FilterOperator).EQ,e)];t.read("/BasketSet",{filters:o,success:function(e){r.setProperty("/shoppingcart",e.results);console.log("BasketSet loaded:",e.results)},error:function(e){sap.m.MessageBox.error("Fejl ved load af varekurv data. Genindlæs siden.");console.error("BasketSet read error",e)}})},onFilterMaterialsByList:function(e){const t=this._getCurrentUserNo();var r=this.getView().getModel("view").getProperty("/selectedList");this._loadCatalogSet(t,r)},_loadCatalogSet:function(e,t){var r=this.getOwnerComponent().getModel();var o=this.getView().getModel("view");var i=sap.ui.model.Filter;var s=sap.ui.model.FilterOperator;var n=[new i("UserNo",s.EQ,e)];if(t&&t!=="Alle varer"&&t!==""){n.push(new i("FavoriteList",s.EQ,t))}sap.ui.core.BusyIndicator.show(0);r.read("/CatalogSet",{filters:n,urlParameters:{$expand:"CatalogAttributeSet",$format:"json"},success:function(e,r){sap.ui.core.BusyIndicator.hide();o.setProperty("/catalog",e.results);var i=this.byId("searchField");if(i&&i.getValue()!==""){i.setValue("");var s=this.getView().byId("catalogList");s.getBinding("items").filter([])}console.log("CatalogSet loaded successfully for list:",t||"Alle varer")}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("Fejl ved load af katalogdata: "+(t||"Alle varer"));console.error("CatalogSet read error",e)}.bind(this)})},handleIconTabBarSelect:function(e){var t=e.getParameter("selectedKey");var r=this.getView().getModel("view");r.setProperty("/selectedTabKey",t);if(t==="HeadXSoegning"){this.getOwnerComponent().getRouter().navTo("Routexdocvaresog")}if(t==="HeadInfo"){this.getOwnerComponent().getRouter().navTo("Routeinfo")}if(t==="HeadXOversigt"){this.getOwnerComponent().getRouter().navTo("Routexdocbestilling")}if(t==="HeadXProfil"){this.getOwnerComponent().getRouter().navTo("Routexdocprofil")}if(t==="HeadXSupport"){this.getOwnerComponent().getRouter().navTo("Routexdocsupport")}},onSearchMaterials:function(e){var t=e.getParameter("newValue");var r=[];if(t){var o=new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter("Maktx",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("MaktxLong",sap.ui.model.FilterOperator.Contains,t);var n=new sap.ui.model.Filter("Levmat",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("KeywordSearch",sap.ui.model.FilterOperator.Contains,t);var l=new sap.ui.model.Filter({filters:[o,i,s,n,a],and:false});r.push(l)}var d=this.getView().byId("catalogList");var g=d.getBinding("items");g.filter(r)},onAddToCart:function(e){var r=e.getSource();var o=r.getBindingContext("view");var s=o.getObject();const n=this._getCurrentUserNo();var a=s.GuidMat;var l=s.Matnr;var d={UserNo:n,GuidMat:s.GuidMat,OrderQuantity:s.Multiplum};var g=this.getOwnerComponent().getModel();var c="/BasketSet";g.create(c,d,{success:function(e){this._loadBasket(n);t.show(e.Maktx+" tilføjet til kurv")}.bind(this),error:function(e){var t="Fejl ved tilføjelse til kurv. Prøv igen";try{if(e&&e.responseText){var r=JSON.parse(e.responseText);if(r.error&&r.error.message&&r.error.message.value){t=r.error.message.value}else if(r.error&&r.error.innererror&&r.error.innererror.errordetails&&r.error.innererror.errordetails.length>0){t=r.error.innererror.errordetails[0].message||t}}else if(e&&e.message){t=e.message}}catch(e){console.error("Fejl ved parsing af OData fejl:",e)}i.error(t);console.error("Varekurv fejl:",e)}})},onDecreaseQuantity:function(e){var r=e.getSource();var o=r.getBindingContext("view");var s=o.getObject();const n=this._getCurrentUserNo();var a=s.GuidMat;var l=s.Matnr;var d=s.Multiplum;var g="-"+d.toString();var c={UserNo:n,GuidMat:s.GuidMat,OrderQuantity:g};var u=this.getOwnerComponent().getModel();var v="/BasketSet";u.create(v,c,{success:function(e){this._loadBasket(n);t.show(s.Maktx+" fjernet fra kurv")}.bind(this),error:function(e){i.error("Der skete en fejl ved opdatering af varekurven.");console.error("Varekurv fejl:",e)}})},onRemoveFromCart:function(e){var r=e.getSource();var o=r.getBindingContext("view");var s=o.getObject();const n=this._getCurrentUserNo();var a=s.Matnr;var l=parseInt(s.OrderQuantity,10);var d="-"+l.toString();if(l<=0||isNaN(l)){t.show("Kurven er tom");return}var g={UserNo:n,GuidMat:s.GuidMat,OrderQuantity:d};var c=this.getOwnerComponent().getModel();var u="/BasketSet";c.create(u,g,{success:function(e){this._loadBasket(n);t.show(s.Maktx+" fjernet fra kurv")}.bind(this),error:function(e){i.error("Fejl ved fjernelse af vare fra kurv. Prøv venligst igen.");console.error("BasketSet create error:",e)}})},onOrder:function(){var e=this.getView().getModel("view").getProperty("/shoppingcart")||[];var r=e.reduce(function(e,t){return e+parseInt(t.OrderQuantity,10)},0);if(r===0){t.show("Kurven er tom.");return}if(!this._oOrderDialog){o.load({id:this.getView().getId(),name:"rm.webshop.test.view.fragment.XdocOrderDialog",controller:this}).then(function(e){this._oOrderDialog=e;this.getView().addDependent(e);this._setupOrderDialog(r)}.bind(this))}else{this._setupOrderDialog(r)}},_setupOrderDialog:function(e){var t=this.getView().getModel("view");var o=t.getProperty("/UserContact")||{email:"",phone:"",address:{}};var i=new r({alternativeAddress:{streetName:"",streetNr:"",postalCode:"",city:""},contactInfo:{email:o.email,phone:o.phone},registeredAddress:o.address,totalItems:e,selectedAddressOption:0,chosenAddress:null});this._oOrderDialog.setModel(i,"orderDialog");this._oOrderDialog.open()},onConfirmOrder:function(){var e=sap.m.MessageBox;var t=this._oOrderDialog.getModel("orderDialog");var r=t.getData();var o;var i=r.selectedAddressOption;var s=this.getOwnerComponent().getModel("webshop");if(i===0){var n=this.getView().getModel("view");var a=n.getProperty("/UserContact/address");if(!a||!a.streetName){e.error("Der mangler registreret adresseinformation for brugeren.");return}o=a.streetName+" "+a.streetNr+", "+a.postalCode+" "+a.city}else{var l=r.alternativeAddress;if(!l.streetName||!l.streetNr||!l.postalCode||!l.city){e.error("Udfyld venligst alle felter for den alternative adresse.");return}o=l.streetName+" "+l.streetNr+", "+l.postalCode+" "+l.city}var d=this.byId("emailInput");var g=d?d.getValue():"";g=g.trim();if(!g){e.error("Udfyld venligst email-adressen for kontaktinformation.");return}var c=this.byId("emailInput");var u=c.getValue().trim()||"";if(u.length>0){if(!u.includes("@")||!u.includes(".")){e.error("Indtast venligst en gyldig e-mailadresse.");return}}r.contactInfo.email=g;var v=this.byId("phoneInput");var h=v.getValue()||"";var f=h.replace(/[^0-9]/g,"");if(f.length>0){if(f.length!==8){e.error("Telefonnummeret skal bestå af præcis 8 cifre (uden landekode), hvis det udfyldes.");return}var m=f;r.contactInfo.phone=m}else{r.contactInfo.phone=null}r.chosenAddress=o;t.setData(r);this._openFinalConfirmationDialog()},onCancelOrder:function(){this._oOrderDialog.close()},_openFinalConfirmationDialog:function(){if(!this._oFinalConfirmationDialog){o.load({id:this.getView().getId(),name:"rm.webshop.test.view.fragment.FinalConfirmationDialog",controller:this}).then(function(e){this._oFinalConfirmationDialog=e;this.getView().addDependent(e);this._setupFinalConfirmationDialog()}.bind(this))}else{this._setupFinalConfirmationDialog()}},_setupFinalConfirmationDialog:function(){var e=this._oOrderDialog.getModel("orderDialog").getData();this.byId("finalAddressText").setText(e.chosenAddress);this.byId("finalEmailText").setText("Email: "+e.contactInfo.email);this.byId("finalPhoneText").setText("Telefon: "+e.contactInfo.phone);this.byId("finalConfirmationText").setText(this.getResourceBundle().getText("Bekræft venligst din bestilling.")||"Bekræft venligst din bestilling.");this._oFinalConfirmationDialog.open()},onFinalOrder:function(){this._oFinalConfirmationDialog.close();this._openOrderSentDialog()},onFinalCancel:function(){this._oFinalConfirmationDialog.close()},_openOrderSentDialog:function(){if(!this._oOrderSentDialog){o.load({id:this.getView().getId(),name:"rm.webshop.test.view.fragment.OrderSentDialog",controller:this}).then(function(e){this._oOrderSentDialog=e;this.getView().addDependent(e);this._setupOrderSentDialog()}.bind(this))}else{this._setupOrderSentDialog()}},_setupOrderSentDialog:function(){var e=this._oOrderDialog.getModel("orderDialog");var t=e.getProperty("/contactInfo/email");var r=this.getResourceBundle().getText("orderSentConfirmation",[t]);var o=this.byId("orderSentText");if(o){o.setText(r)}this._oOrderSentDialog.open()},onOrderSentConfirm:function(){this._oOrderSentDialog.close();this._processFinalOrder()},_processFinalOrder:function(){var e=this;var t=this._oOrderDialog.getModel("orderDialog");var r=t.getData();var o=this.getOwnerComponent().getModel();var s=this.getView().getModel("view");const n=this._getCurrentUserNo();var a=r.chosenAddress||"";var l=a.split(",");var d=l[0]?l[0].trim():"";var g=l[1]?l[1].trim():"";var c=d;var u=g.split(" ");var v=u[0]||"";var h=u.slice(1).join(" ")||"";var f=s.getProperty("/UserContact")||{};var m={UserNo:n,Name:s.getProperty("/UserInfo/doctor")||"",Name2:"",Street:c||f.address.streetName+" "+f.address.streetNr,Zip:v||f.address.postalCode,City:h||f.address.city,Att:"",Phone:r.contactInfo.phone||f.phone,EMail:r.contactInfo.email||f.email};o.create("/OrderHeaderSet",m,{success:function(t,r){var o=t.OrderNumber||"Ukendt";i.success("Ordren "+o+" er afsendt.");e._oOrderDialog.close();e._loadBasket(n);e.getOwnerComponent().getRouter().navTo("Routexdocbestilling")},error:function(e){i.error("Fejl ved afsendelse af ordre. Prøv igen.");console.error("OrderHeaderSet CREATE error:",e)}})},_fetchUserData:function(){var e=this.getOwnerComponent().getModel();var r=this.getView().getModel("view");const o=this._getCurrentUserNo();const i=`/UserSet('${o}')`;if(!e){t.show("Error: OData model not available.");return}e.read(i,{urlParameters:{$format:"json"},success:function(e){r.setProperty("/UserInfo",{doctor:e.AdrName||"N/A",ydernr:e.Ydernr||"N/A",cvrnr:e.Cvr||"N/A",brugernr:e.UserNo||"N/A"});r.setProperty("/UserContact",{email:e.EMail||"",phone:e.Phone||"",address:{streetName:e.AdrStreet||"",streetNr:e.AdrHouseNo||"",postalCode:e.AdrZip||"",city:e.AdrCity||""}})}.bind(this),error:function(e){t.show("Failed to load user data.");console.error("OData Read failed:",e);r.setProperty("/UserInfo",{doctor:"Fejl: Kunne ikke hente data",ydernr:"",cvrnr:"",brugernr:""})}.bind(this)})},_fetchInitFav:function(){var e=this.getOwnerComponent().getModel();var r=this.getView().getModel("view");const o=this._getCurrentUserNo();const i=`/UserSet('${o}')`;if(!e){t.show("Error: OData model not available.");return}e.read(i,{urlParameters:{$format:"json"},success:function(e){const t=e.FavoriteList||"Alle varer";r.setProperty("/selectedList",t);this._loadCatalogSet(o,t)}.bind(this),error:function(){t.show("Fejl i søgning efter favoritliste ved start")}.bind(this)})},onBack:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);var t=this.getView().getModel("view");var r=this._getCurrentUserNo();var o=this.getOwnerComponent().getModel();var i=[new sap.ui.model.Filter("UserNo",sap.ui.model.FilterOperator.EQ,r)];o.read("/BasketSet",{filters:i,success:function(t){var r=t.results||[];if(r.length>0){sap.m.MessageBox.confirm("Du har varer i din kurv. Vil du fortsat logge af? (Din kurv gemmes til næste besøg)",{title:"Bekræft log af",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(t){if(t===sap.m.MessageBox.Action.OK){e.navTo("Routemain")}}})}else{e.navTo("Routemain")}},error:function(t){sap.m.MessageBox.warning("Kunne ikke hente din kurv. Vil du fortsætte med at logge af?",{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(t){if(t===sap.m.MessageBox.Action.OK){e.navTo("Routemain")}}});console.error("BasketSet read error during logoff:",t)}})}})});
//# sourceMappingURL=xdocvaresog.controller.js.map